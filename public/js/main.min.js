String.prototype.countOf=function(b){for(var c=0,d=this.length;d--;)this[d]===b&&c++;return c};var control_head,userinfo={nickname:""},chat={props:["userinfo","socket"],template:`<div> <div id="chat" class="row"> <div> <ul id="slide-out" data-activates="slide-out" class="side-nav"> <li> <div class="userView"> </div></li><li class=""><a href="#"><i class="material-icons white-text circle teal lighten-3 col s3 center">perm_identity</i>{{userinfo.nickname}}</a></li><li> <form onsubmit="return false;"> <div class="input-field z-depth-1"> <input id="session" type="search" placeholder = "sessão ID/Nome" @keydown.enter="newsession" v-model="sessioninsearch" required> <label class="label-icon" for="session"><i class="material-icons">search</i></label> </div></form> </li><div class = "divider"></div><li> <a><div class="switch"> <label> Privado <input id="opensession" v-model="opensession" type="checkbox"> <span class="lever"></span> Publico </label> </div></a> </li><li> <a class="waves-effect" @click="createnewsession" href="#"> Criar Nova Sessão </a> </li><div class = "divider"></div><li><a @click="publicsession" class="waves-effect" href="#">Iniciar Em Sessão Pública</a></li><li v-if = "startSession"> <a href="#" class = "waves-effect" @click = "startSession = false"> Ver Sessões Abertas </a> </li><li v-else-if = "!startSession && sessionsRegister.length > 0"> <a href="#" class = "waves-effect" @click = "startSession = true"> Voltar As Minhas Sessões </a> </li><li v-if="msgerror.condiction===true"><a class="red-text" href="#">{{msgerror.value}}</a></li></ul> </div><nav> <div class="nav-wrapper teal col s12"> <a href="#" data-activates="slide-out" class="button-collapse nav-s"> <i class="material-icons">menu</i> </a> <ul id="nav-mobile" class="left hide-on-med-and-down"> <li> <a href="#" data-activates="slide-out" class="collapse-navside"><i class="material-icons">menu</i></a></li></ul>  <div class="center" v-if="startSession"> Sua Sessão Atual é : {{sessionName}}</div>  </div></nav> <div v-if="startSession===false" class="row col s12"> <div class="flow-text center"> Sessões Abertas </div> <div class="col s10 offset-s1 collection spc"> <div v-for="sessop in opensessions" class="left"> <a href="#" @click="newsession(sessop)" class="btn transparent teal-text waves-effect waves-teal">{{sessop.name}}</a> </div></div></div> <div v-if="startSession"> <div id="viewmsg"> <div id="showmessages" class="col s12 m12 offset-m1 offset-s1"> <span v-if = "sessionID !== '__public_session__' " class = "">ID : {{sessionID}} </span>  <ul class="col s12 m3 "> <div class="col s12"> <span class="flow-text"> Sessões </span> </div><div class="collection"> <li class="" v-for="(sess, index) in sessions"> <div class="collection-item"> <a @click="changesession(sess.id, sess.name)" v-bind:class="[sess.id===sessionID ? 'teal-text': 'purple-text']" class=" click waves-light waves-effect">{{sess.name}}<span v-if="sessionsNews[sess.id].news > 0" class="new badge">{{sessionsNews[sess.id].news}}</span> </a> <a @click="finishsession(sess)" class="right valign click"><i class="material-icons">close</i></a> </div></li></div><send-file v-bind:data="{session:sessionID, nick:userinfo.nickname}"></send-file></ul> <ul id="msgs" class="col s12 m9 right z-depth-1"> <li v-for="(msg, index) in chat" v-bind:class="[msg.user===userinfo.nickname ? 'fadeInRight' : 'fadeInLeft']" class="msgn animated col s12"> <div v-if="msg.type!=='info' "> <div v-bind:class="[msg.user===userinfo.nickname ? 'right blue white-text' : 'left black-text']" class="chipmodified expand"> <div class=""> <div v-bind:class="[msg.user===userinfo.nickname ? 'right white-text' : 'left teal-text darken-4']" class="col s12"> <span class="nickuser">{{msg.user}}</span> <div class="right datemsg"><i class="material-icons showdatemessage">query_builder</i>{{msg.date}}</div></div></div></br><span v-if = "msg.type === 'message'" ><view-msg :msg = "msg.value"></view-msg></span> <div class = "imgmessage" v-else><img width = "250px" @click = "showBigimg=msg.value" :src="'data:image/png;base64,'+msg.value"> </div></div> </div><div v-else-if="msg.type==='info' "> <div class="col s12 center"> <div class="chipmodified"> <span v-bind:class="msg.class"> {{msg.enphase}} </span> {{msg.value}} <span class="right"> <i class="material-icons configicon">query_builder</i>{{msg.date}}</span></div></div></div></li></ul> </div></div><div class="col s3" v-if="Sevent.iswritten===true && Sevent.session===sessionID"> <span class="teal-text"> Algo está sendo escrito ... </span> </div><div class="page-footer"> <form> <div class="col s12 m9 right"> <div class="input-field col s11 m11"> <i class="material-icons prefix">textsms</i> <textarea id="message" class="materialize-textarea" @keyup="eventkeyupmessage" @keypress="eventkeydownmessage" v-model="message"></textarea> <label for="message">message</label> </div><div id="sendmsg" class="valign-wrapper"> <a @click="sendMessage" class="waves-light waves-effect teal-text"><i class="material-icons">send</i></a> </div></div></form> </div></div> </div> <div v-if = "showBigimg!==''" class = "showimg enter valign-wrapper"><div class = "valing viewimg"><img class = "animated fadeInRight show" @click = "showBigimg=''" :src="'data:image/png;base64,'+showBigimg"></div> </div></div>`,mounted(){appcontrol.$on("registerComand",a=>{this.registerComand(a,"json")})},created(){this.loadEmojiJson(),this.notifysound=new Audio("/audio/notify.mp3"),window.addEventListener("blur",()=>{this.notificationSound=!0}),window.addEventListener("focus",()=>{this.notificationSound=!1,this.zeronews()}),window.setTimeout(()=>{$(".collapse-navside").sideNav(),$(".nav-s").sideNav()},50);var a;this.socket.on("getAllSessionsOpen",a=>{this.opensessions=a}),this.socket.emit("reqAllSessionsOpen"),this.socket.on("receivemessage",b=>{a=document.querySelector("#msgs"),this.registerComands.onSays.length>0&&b.user!==this.userinfo.nickname&&this.registerComands.emit("onSays",b.msg),this.notificationSound===!0?b.session===this.sessionID?(this.soundNotification(),control_head.notifications++):(this.soundNotification(),control_head.secondarynotify++):null,void 0!==this.chatStorage[b.session]?this.chatStorage[b.session].push({type:b.type,session:b.session,user:b.user,value:b.msg,date:b.date}):null,void 0!==this.sessionsNews[b.session]&&this.sessionID!==b.session?this.sessionsNews[b.session].news++:null,window.setTimeout(()=>{a.scrollTop=a.scrollHeight,$(".materialboxed").materialbox()},50)}),this.socket.on("onlines",a=>{this.usersonline=a}),this.socket.on("useriswritten",a=>{this.Sevent={iswritten:!0,session:a}}),this.socket.on("userstopedwritten",a=>{this.Sevent={iswritten:!1,session:a}}),this.socket.on("eventclient",b=>{a=document.querySelector("#msgs"),void 0!==this.chatStorage[b.session]?this.chatStorage[b.session].push({type:"info",enphase:b.user,value:b.msg,date:b.date,class:"cyan-text darken-3"}):null,a.scrollTop=a.scrollHeight}),this.socket.on("erroronsession",(a,b)=>{a?this.msgerror={condiction:!0,value:a}:(this.startSession=!0,this.msgerror.condiction=this.msgerror={condiction:!1,value:""},"public"===b?(this.sessionID="__public_session__",this.sessionsRegister.indexOf(this.sessionID)===-1&&(this.sessionName="Sessão Pública",this.sessionsNews[this.sessionID]={news:0},this.sessions.push({id:this.sessionID,name:this.sessionName}),this.chatStorage[this.sessionID]=[],this.chat=this.chatStorage[this.sessionID],this.sessionsRegister.push(this.sessionID),$("#sidenav-overlay").trigger("click"))):(this.sessionID=b.id,this.sessionsRegister.indexOf(this.sessionID)===-1&&(this.sessionName=b.name,this.sessioninsearch="",this.sessionsNews[this.sessionID]={news:0},this.sessions.push({id:this.sessionID,name:this.sessionName,open:b.opens}),this.chatStorage[this.sessionID]=[],this.chat=this.chatStorage[this.sessionID],this.sessionsRegister.push(this.sessionID),$("#sidenav-overlay").trigger("click"))))})},data(){return{socket:null,message:"",messagehtml:"",canSendMessage:!0,chatStorage:[],chat:[],messages:[],infos:[],usersonline:0,Sevent:{},onstoped:null,startSession:!1,sessioninsearch:"",sessionID:"",opensession:!1,opensessions:[],sessions:[],sessionsNews:[],sessionsRegister:[],sessionName:"",msgerror:{condiction:!1,value:""},notificationSound:!1,showBigimg:"",emojiInfo:"",registerComands:{onSays:[],emit(a,b){this[a].forEach(a=>{a.method(b)})},registers:[]}}},computed:{},watch:{startSession(){this.startSession===!0&&window.setTimeout(()=>{document.getElementById("msgs").style.height=`${window.innerHeight/1.7}px`,document.getElementById("appcontrol").style.height=`${window.innerHeight-20}px`},50)}},methods:{sendMessage(){""!==this.message&&"\n"!==this.message&&1==this.canSendMessage&&(this.socket.emit("sendmessage",{session:this.sessionID,user:this.userinfo.nickname,msg:""!==this.messagehtml?this.messagehtml:this.message}),this.canSendMessage=!1,document.getElementById("message").value="",this.message="",this.messagehtml="")},eventkeydownmessage(a){this.verifyIsEmoji(),13===a.keyCode&&""!==this.message&&this.canSendMessage===!0?"@"===this.message[0]?(this.registerComand(this.message),this.message="",document.getElementById("message").value=""):this.sendMessage():this.socket.emit("written")},eventkeyupmessage(a){this.verifyIsEmoji(),clearTimeout(this.onstoped),this.onstoped=window.setTimeout(()=>{this.socket.emit("stopedwritten")},700),this.message.countOf("\n")===this.message.length||this.message.countOf(" ")===this.message.length?(this.message="",this.canSendMessage=!0):this.canSendMessage=!0},createnewsession(){""!==this.sessioninsearch?(this.socket.emit("createnewsession",this.sessioninsearch,{opsess:this.opensession}),this.opensession=!1):(this.msgerror={condiction:!0,value:'Preencha O Campo "Session ID/Nome" '},document.getElementById("session").focus())},newsession(){arguments.length>0&&void 0!==arguments[0].id?this.sessionsRegister.indexOf(arguments[0].id)>=0?this.changesession(arguments[0].id,arguments[0].name):this.socket.emit("newsession",arguments[0].id):""!==this.sessioninsearch&&this.socket.emit("newsession",this.sessioninsearch)},publicsession(){"__public_session__"!==this.sessionID&&this.socket.emit("publicsession")},changesession(a,b){this.startSession===!1?this.startSession=!0:null,messagedom=document.querySelector("#msgs"),this.sessionID=a,this.sessionName=b,this.chat=this.chatStorage[this.sessionID],this.zeronews(),this.socket.emit("changesession",a),window.setTimeout(()=>{null!==messagedom&&void 0!==messagedom?messagedom.scrollTop=messagedom.scrollHeight:null},50)},finishsession(a){void 0!==a&&(this.sessionsRegister.splice(this.sessionsRegister.indexOf(a.id),1),this.sessions.splice(this.sessions.indexOf(a),1),this.socket.emit("finishsession",a),0===this.sessionsRegister.length?this.startSession=!1:null,void 0!==this.sessions[0]?this.changesession(this.sessions[0].id,this.sessions[0].name):this.sessionID="")},zeronews(){this.sessionsNews[this.sessionID].news>0?(control_head.secondarynotify-=this.sessionsNews[this.sessionID].news,this.sessionsNews[this.sessionID].news=0):null,control_head.notifications=0},soundNotification(){this.notifysound.play()},loadEmojiJson(){var a=new XMLHttpRequest;a.open("GET","/emoji.json",!0),a.onload=(()=>{200===a.status?this.emojiInfo=JSON.parse(a.responseText):console.log("fail on load emoji Json")}),a.send()},verifyIsEmoji(){var a="null";this.message.replace(/:(.*?):/gi,(b,c)=>{a=c in this.emojiInfo?this.emojiInfo[c]:"null"}),"null"!==a&&(this.message=this.message.replace(/:(.*?):/gi,(a,b)=>{return b in this.emojiInfo?this.emojiInfo[b]:a}),a="null")},registerComand(a){var b,c=this.socket,d={sessionID:this.sessionID,nick:this.userinfo.nickname};if(void 0!==arguments[1]&&"json"===arguments[1])try{b=JSON.parse(a)}catch(a){console.log(a)}finally{if(void 0!==this.registerComands.onSays)for(msg in b)void 0===this.registerComands.registers[msg]&&(this.registerComands.onSays.push({say:msg,response:b[msg],method(a){a===this.say&&c.emit("sendmessage",{session:d.sessionID,user:d.nick,msg:this.response})}}),this.registerComands.registers.push(msg))}else{b=a.split(",").length>1?a.split(","):[a];for(var e=0;e<b.length;e++)a=b[e].split(":"),void 0!==this.registerComands[a[0].substr(1)]&&this.registerComands[a[0].substr(1)].push({say:a[1],response:a[2],method(a){a===this.say&&c.emit("sendmessage",{session:d.sessionID,user:d.nick,msg:this.response})}})}}}};Vue.component("menu-app",{template:'<div> <div class="card-panel teal lighten-2"> <span class="white-text"> {{message}} </span> </div> </div>',data(){return{message:"this is a prototype of webchat"}}}),Vue.component("view-msg",{props:["msg"],template:'<div><span ref = "span">{{msg}}</span></div>',data(){return{teste:"este é o teste"}}});var login={props:["socket"],template:`<div> <div class="container"> <menu-app></menu-app> <div class="row"> <div id = "login" class="col s12 m4 offset-m4 z-depth-1"> <form class="right" onsubmit="return false;"> <div class="input-field col s12"> <input id="username" v-model="username" type="text" class="validate"> <label for="username"> Username </label> </div><div class="input-field col s12"> <input id="password" v-model="password" type="password" class="validate"> <label for="password">Password</label> <button @click="checklogin('1')" class="waves-effect waves-light btn" type="button"> Login </button> <button @click="checklogin('2')" class="waves-effect waves-light btn" type="button"> guest </button> <div class="red-text" v-if="showmessageerror===true">{{errormessage}}</div></div></form> </div></div></div> </div>`,created(){this.socket.on("login_ok",a=>{appcontrol.viewpage="chat",appcontrol.userinfo.nickname=a}),this.socket.on("login_fail",()=>{this.showmessageerror=!0,this.errormessage="falha ao tentar autenticação"}),this.socket.on("userisconnected",()=>{this.showmessageerror=!0,this.errormessage="Usuário já está conectado"})},data(){return{username:"",password:"",showmessageerror:!1,errormessage:""}},methods:{checklogin(){"1"===arguments[0]?""===this.username||""===this.password?(this.showmessageerror=!0,this.errormessage="Preencha Todos Os Campos"):this.socket.emit("checklogin",{username:this.username,pass:this.password}):"2"===arguments[0]&&(""===this.username?(this.showmessageerror=!0,this.errormessage="Escolha um nome de usuário"):this.socket.emit("checkloginguest",{username:this.username}))}}};Vue.component("send-file",{props:["data"],template:'<div> <div id = "menuoptchat" class="fixed-action-btn horizontal click-to-toggle right"> <a class="btn-floating btn-large teal"> <i class="material-icons">menu</i> </a> <ul> <li><a class="btn-floating red disabled"><i class="material-icons">insert_chart</i></a></li><li><a class="btn-floating yellow darken-1 disabled"><i class="material-icons">format_quote</i></a></li><li><a class="btn-floating cyan accent-4 disabled" ><i class="material-icons">note_add</i></a></li><li><a @click = "inputfile.click()" class="btn-floating blue"><i class="material-icons">attach_file</i></a></li></ul> </div> <div class = "col s12 center" id = "result" v-html = "result"></div> </div>',created(){this.inputfile.setAttribute("type","file"),this.inputfile.setAttribute("id","filetemporary"),this.inputfile.setAttribute("name","filetemporary"),this.img.setAttribute("class","animated fadeInRight imgpreview"),this.previewimg.setAttribute("class","showimg"),this.inputfile.addEventListener("change",this.preparedSendFile),this.xhr.upload.addEventListener("progress",this.onProgressXHR,!1)},data(){return{fileIsSend:!1,filesend:"",previewimg:document.createElement("div"),inputfile:document.createElement("input"),opts:document.createElement("div"),xhr:new XMLHttpRequest,fr:new FileReader,img:new Image,result:"",file:""}},methods:{sendfile(a){var b=new FormData;b.append("filetemporary",a,a.name),b.append("sessionid",this.data.session),b.append("username",this.data.nick),this.xhr.open("POST","/sendfileTemporary",!0),this.xhr.onload=(()=>{if(200!==this.xhr.status)throw"Falha Ao Tentar Upload Do Arquivo"}),this.xhr.onloadstart=(()=>{this.previewimg.innerHTML='<div class="preloader-wrapper big active Absolute-Center"> <div class="spinner-layer spinner-blue"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-red"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-yellow"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-green"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div></div></div><div class="Absolute-Center progress"><div class="determinate" style="width:0%"></div></div>'}),this.xhr.onloadend=(()=>{this.previewimg.innerHTML="",document.body.removeChild(this.previewimg)}),this.xhr.send(b)},preparedSendFile(a){this.file=a.target.files[0];var b;this.fr.onload=(()=>{""===this.file.type||"image"!==this.file.type.substr(0,5)?(b=this.getFileExtension(),"json"===b&&"bot.json"===this.file.name?(appcontrol.$emit("registerComand",this.fr.result),this.result='<div class ="green-text col s12">Arquivo Carregado Com Sucesso <i class = "material-icons">done</i></div>'):this.result='<div class ="red-text col s12"> <i class = "material-icons">warning</i> Arquivo Inválido </div>'):"image"!==this.file.type.substr(0,5)?this.result='<span class = "red-text"> Não é uma arquivo/imagem válida !! </span>':"image"===this.file.type.substr(0,5)&&(this.opts.setAttribute("class","col s12 aling-center"),this.opts.innerHTML='<button id = "cancel-sendimage" class = "btn waves-red waves-effect red"> <i class = "material-icons">close</i> </button> <button id = "confirm-sendimage" class = "btn waves-teal waves-effect"> <i class = "material-icons">done</i> </button>',this.img.src=this.fr.result,this.previewimg.appendChild(this.img),this.previewimg.appendChild(this.opts),document.body.appendChild(this.previewimg),document.getElementById("confirm-sendimage").addEventListener("click",this.onConfirm,!1),document.getElementById("cancel-sendimage").addEventListener("click",this.onCancel,!1),this.result="")}),this.fr.onloadstart=(()=>{this.result=`<div class="preloader-wrapper big active"> <div class="spinner-layer spinner-blue"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-red"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-yellow"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div><div class="spinner-layer spinner-green"> <div class="circle-clipper left"> <div class="circle"></div></div><div class="gap-patch"> <div class="circle"></div></div><div class="circle-clipper right"> <div class="circle"></div></div></div></div>`}),""===this.file.type?this.fr.readAsText(this.file,"utf-8"):this.fr.readAsDataURL(this.file)},onConfirm(){this.sendfile(this.file),this.opts.innerHTML="",this.inputfile.value=""},onCancel(){document.body.removeChild(this.previewimg),this.opts.innerHTML="",this.inputfile.value=""},onProgressXHR(a){if(a.lengthComputable){var b=a.loaded/a.total;document.querySelector(".determinate").style.width=`${100*b}%`}else console.log("not is possible verify the progress")},getFileExtension(){if(this.file.name.indexOf(".")>=0)return this.file.name.substr(this.file.name.indexOf(".")+1)}}});var appcontrol=new Vue({el:"#appcontrol",created(){this.socket=io.connect()},data(){return{socket:null,userinfo:{nickname:""},viewpage:"login",opt:!1}},components:{login:login,chat:chat}});control_head=new Vue({el:"#control-head",data(){return{notifications:0,secondarynotify:0}},computed:{title(){return`webchat.io ${this.notifications+this.secondarynotify>0?this.notifications+this.secondarynotify:""}`}}});